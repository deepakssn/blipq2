# Project Blipq2 (Generated by Jules)

This application is a full-stack web platform, with the backend and frontend components developed with the assistance of Jules from Google.

A special thank you to Google Jules for generating the foundational code for this project!

This application is designed to be deployed to the Google Cloud Platform (GCP) Standard Environment. This README provides step-by-step instructions for setting up the development environment, running the application locally, and deploying it to GCP.

## Table of Contents

- [Prerequisites](#prerequisites)
- [Environment Variables](#environment-variables)
- [Local Environment Setup](#local-environment-setup)
  - [Backend Setup](#backend-setup)
  - [Frontend Setup](#frontend-setup)
- [Running the Application Locally](#running-the-application-locally)
  - [Running the Backend](#running-the-backend)
  - [Running the Frontend](#running-the-frontend)
- [Deployment to GCP App Engine (Standard Environment)](#deployment-to-gcp-app-engine-standard-environment)
  - [GCP Project Setup](#gcp-project-setup)
  - [Database Setup (MongoDB Atlas)](#database-setup-mongodb-atlas)
  - [Backend Deployment](#backend-deployment)
  - [Frontend Deployment](#frontend-deployment)
  - [Setting Environment Variables in GCP](#setting-environment-variables-in-gcp)
- [Platform-Specific Setup Guides](#platform-specific-setup-guides)
  - [Node.js & npm/yarn](#nodejs--npmyarn)
  - [MongoDB](#mongodb)
  - [Google Cloud SDK (gcloud CLI)](#google-cloud-sdk-gcloud-cli)

## Prerequisites

Before you begin, ensure you have the following installed on your system:

-   **Node.js:** We recommend using the latest LTS version (v20.x.x or later). This is required for both the backend and frontend.
-   **npm (Node Package Manager) or yarn:** npm comes bundled with Node.js. Yarn is an alternative package manager. This README will use `npm` in its examples.
-   **MongoDB:** A local MongoDB instance or access to a MongoDB Atlas cluster (or similar cloud-hosted MongoDB service) is required for the backend to store data.
-   **Google Cloud SDK (`gcloud` CLI):** Required for deploying the application to Google Cloud Platform.
-   **Git:** For cloning the repository and version control.

## Environment Variables

This application requires certain environment variables to be set for proper functioning. Create a `.env` file in the root directory of the project (for the backend) and populate it with the following variables.

**Backend (`.env` file in the project root):**

```env
# Server Configuration
NODE_ENV=development
PORT=5000

# MongoDB Configuration
MONGODB_URI=your_mongodb_connection_string # e.g., mongodb://localhost:27017/blipq2_dev or from MongoDB Atlas
DB_NAME=blipq2_dev # Optional: specify a database name

# JWT Authentication
JWT_SECRET=your_very_strong_jwt_secret_key
JWT_EXPIRE=30d # Access token expiration (e.g., 30d, 1h, 60m)
JWT_REFRESH_SECRET=your_very_strong_jwt_refresh_secret_key
JWT_REFRESH_EXPIRE=60d # Refresh token expiration

# Email Configuration (using nodemailer, e.g., with SendGrid, Mailgun, or Gmail for development)
EMAIL_HOST=your_smtp_host
EMAIL_PORT=your_smtp_port # (e.g., 587 for TLS, 465 for SSL)
EMAIL_USERNAME=your_smtp_username
EMAIL_PASSWORD=your_smtp_password
EMAIL_FROM_ADDRESS=noreply@example.com # Sender email address
EMAIL_FROM_NAME="Blipq2 App" # Sender name

# Application URLs
APP_BASE_URL=http://localhost:3000 # Base URL of your frontend application (used for email links)

# Domain Configuration for Roles
SUPERADMIN_DOMAINS=yourdomain.com,anotherdomain.net # Comma-separated list of domains allowed for superAdmin registration
```

**Note on `EMAIL_` variables:** For development, you can use services like Ethereal for testing email sending without actually sending real emails, or configure a Gmail account (though this might require enabling "less secure app access" which is not recommended for production). For production, use a transactional email service like SendGrid, Mailgun, AWS SES, etc.

**Frontend (`client/.env.local` or `client/.env` - Create React App specific):**

Create React App uses `REACT_APP_` prefix for environment variables to be embedded in the build. If your frontend needs to know the API endpoint:

```env
REACT_APP_API_URL=http://localhost:5000/api
```
*(Adjust if your API is served on a different port or path locally)*

## Local Environment Setup

Follow these steps to set up the application on your local machine.

1.  **Clone the Repository:**
    ```bash
    git clone https://github.com/deepakssn/blipq2.git
    cd blipq2
    ```

### Backend Setup
The backend is a Node.js/Express application located in the project root.

1.  **Navigate to the project root directory** (if you are not already there).
    ```bash
    # This is the main 'blipq2' directory
    ```

2.  **Install Dependencies:**
    ```bash
    npm install
    ```

3.  **Create and Configure `.env` file:**
    *   Create a file named `.env` in the project root directory.
    *   Copy the content from the "Backend (`.env` file in the project root):" section above into this file.
    *   **Crucially, update `MONGODB_URI`** to point to your local or cloud MongoDB instance.
    *   Update other variables like `JWT_SECRET`, `EMAIL_` settings, and `SUPERADMIN_DOMAINS` as needed.

### Frontend Setup
The frontend is a React application located in the `client/` directory.

1.  **Navigate to the `client` directory:**
    ```bash
    cd client
    ```

2.  **Install Dependencies:**
    ```bash
    npm install
    ```
    This command installs all dependencies listed in `client/package.json`. If you've manually added `express` to `client/package.json` for the App Engine deployment, this will install it. It will also update your `client/package-lock.json` file, which should be committed to your repository.

3.  **Create and Configure `.env.local` file (For Local Development):**
    *   In the `client` directory, create a file named `.env.local`.
    *   Add the following line to specify the backend API URL for local development:
        ```env
        REACT_APP_API_URL=http://localhost:5000/api
        ```
    *   This variable is used by the React application to know where to send API requests. Adjust the port if your local backend runs on a different one. The `REACT_APP_API_URL` is important because there is no `proxy` configured in `client/package.json`.

## Running the Application Locally

Ensure you have completed the "Local Environment Setup" steps for both backend and frontend, including installing dependencies and configuring `.env` files.

### Running the Backend

1.  **Navigate to the project root directory.**
    ```bash
    cd /path/to/blipq2
    ```
2.  **Start the backend server:**
    ```bash
    node app.js
    ```
    Alternatively, you can add a `start` script to your root `package.json`:
    ```json
    // package.json (root)
    "scripts": {
      "start": "node app.js", // Add this line
      "test": "echo \"Error: no test specified\" && exit 1"
    },
    ```
    And then run:
    ```bash
    npm start
    ```
    The backend server should start, typically on port 5000 (or the `PORT` specified in your `.env` file). You should see a log message like `Server running in development mode on port 5000`.

### Running the Frontend

1.  **Open a new terminal window or tab.**
2.  **Navigate to the `client` directory:**
    ```bash
    cd /path/to/blipq2/client
    ```
3.  **Start the frontend development server:**
    Use the `dev` script (which runs `react-scripts start`):
    ```bash
    npm run dev
    ```
    This will usually open the application automatically in your default web browser at `http://localhost:3000`. If it doesn't open automatically, navigate to that URL. The React development server will watch for changes in the frontend code and reload automatically.
    (Note: `npm start` in the `client` directory is now configured to run `node server.js` for the App Engine deployment; use `npm run dev` for local development with live reloading.)

You should now have the backend API server and the frontend React application running locally. The frontend will make requests to the backend API (ensure `REACT_APP_API_URL` in `client/.env.local` is correctly pointing to your local backend, e.g., `http://localhost:5000/api`).

## Deployment to GCP App Engine (Standard Environment)

This application is designed to be deployed to Google Cloud Platform's App Engine Standard Environment. We will deploy it as two services: a `default` service for the backend API and a `frontend` service for the React client application. A `dispatch.yaml` will be used to route traffic appropriately.

### 1. GCP Project Setup

1.  **Create or Select a GCP Project:**
    *   Go to the [GCP Console](https://console.cloud.google.com/).
    *   Create a new project or select an existing one. Note your **Project ID**.
2.  **Enable APIs:**
    *   Ensure the "App Engine Admin API" is enabled for your project. You might be prompted to enable it when deploying for the first time.
    *   If using other GCP services (like Secret Manager), ensure those APIs are enabled as well.
3.  **Install Google Cloud SDK:**
    *   Follow the instructions at [Google Cloud SDK Installation](https://cloud.google.com/sdk/docs/install) to install and initialize the `gcloud` CLI.
4.  **Authenticate `gcloud`:**
    ```bash
    gcloud auth login
    gcloud auth application-default login
    ```
5.  **Set Default Project:**
    ```bash
    gcloud config set project YOUR_PROJECT_ID
    ```
    Replace `YOUR_PROJECT_ID` with your actual GCP Project ID.
6.  **Choose App Engine Region:**
    When deploying your first App Engine service (typically the `default` service), you'll be prompted to choose a region. This cannot be changed later. Choose a region appropriate for your users.

### 2. Database Setup (MongoDB Atlas)

This guide assumes you are using MongoDB Atlas (a cloud-hosted MongoDB service) for production.

1.  **Create a MongoDB Atlas Account and Cluster:**
    *   Go to [MongoDB Atlas](https://www.mongodb.com/cloud/atlas) and sign up or log in.
    *   Create a new cluster. The free tier (M0) is suitable for small applications or testing.
    *   Choose a cloud provider and region for your cluster.
2.  **Configure Database User:**
    *   In your Atlas cluster, go to "Database Access" and create a new database user with read/write access to your desired database (e.g., `blipq2_prod`). Note the username and password.
3.  **Configure Network Access:**
    *   In your Atlas cluster, go to "Network Access".
    *   Add IP addresses that can connect to your database. For App Engine, you can:
        *   Add `0.0.0.0/0` (allow access from anywhere - ensure strong database credentials).
        *   For better security, if your App Engine services need to connect directly, you might need to use a VPC Connector and configure VPC peering with MongoDB Atlas, or use Atlas Private Endpoints. This is more advanced. For simplicity with App Engine Standard, `0.0.0.0/0` is often used initially, relying on strong credentials and SSL.
4.  **Get Connection String:**
    *   In your Atlas cluster, click "Connect", choose "Connect your application", and select the Node.js driver version.
    *   Copy the connection string. It will look something like: `mongodb+srv://<username>:<password>@yourcluster.mongodb.net/yourDatabaseName?retryWrites=true&w=majority`
    *   Replace `<username>` and `<password>` with the credentials you created. You can also specify `yourDatabaseName` directly in the string or use the `DB_NAME` environment variable. This will be your `MONGODB_URI`.

### 3. Backend Deployment (Default Service)

The backend API will be deployed as the `default` service in App Engine. The configuration is in `app.yaml` in the project root.

1.  **Review `app.yaml`:**
    Open `app.yaml` in the project root. Key settings:
    *   `runtime: nodejs20`
    *   `service: default`
    *   `env_variables`:
        *   `APP_BASE_URL`: Set this to your application's main URL (e.g., `https://YOUR_PROJECT_ID.appspot.com` or your custom domain if you set one up later). This is crucial for email links.
    *   Other environment variables (like `MONGODB_URI`, `JWT_SECRET`, etc.) are commented out as they should be set securely (see step 5).

2.  **Ensure `package.json` is ready:**
    *   The root `package.json` should have a `start` script: `"start": "node app.js"`.
    *   All production dependencies must be listed in `dependencies`, not `devDependencies`.

3.  **Deploy the Backend Service:**
    Navigate to the project's root directory (where `app.yaml` is located) in your terminal and run:
    ```bash
    gcloud app deploy app.yaml
    ```
    *   You might be prompted to choose a region if this is the first deployment to App Engine in this project.
    *   This command uploads your code, installs dependencies, and starts the service.

4.  **Set Backend Environment Variables Securely:**
    It's highly recommended to set sensitive environment variables *after* the initial deployment or through secure means, not directly in `app.yaml`. You can use the GCP Console or `gcloud` commands.
    For example, to set `MONGODB_URI` and `JWT_SECRET` for the `default` service:
    ```bash
    gcloud app services update default --update-env-vars MONGODB_URI="your_mongodb_atlas_connection_string",JWT_SECRET="your_strong_secret_key",DB_NAME="blipq2_prod",JWT_EXPIRE="30d",JWT_REFRESH_SECRET="your_strong_refresh_secret",JWT_REFRESH_EXPIRE="60d",EMAIL_HOST="your_smtp_host",EMAIL_PORT="587",EMAIL_USERNAME="your_smtp_user",EMAIL_PASSWORD="your_smtp_password",EMAIL_FROM_ADDRESS="noreply@example.com",EMAIL_FROM_NAME="Blipq2 App",SUPERADMIN_DOMAINS="yourdomain.com"
    ```
    **Important:** Replace placeholder values with your actual configuration. For `APP_BASE_URL`, ensure it's the correct public URL of your frontend (e.g., `https://YOUR_PROJECT_ID.appspot.com` if using `dispatch.yaml` or `https://frontend-dot-YOUR_PROJECT_ID.appspot.com` if not).
    Alternatively, use Secret Manager for more secure handling of secrets.

### 4. Frontend Deployment (Frontend Service)

The React frontend will be deployed as a separate service named `frontend`. It uses a simple Express server (`client/server.js`) to serve the static build.

1.  **Review `client/app.yaml`:**
    Open `client/app.yaml`. Key settings:
    *   `runtime: nodejs20`
    *   `service: frontend`
    *   `env_variables`:
        *   `REACT_APP_API_URL: '/api'` (This assumes you will use `dispatch.yaml` to route `/api/*` requests from the main app domain to the backend service. If not using `dispatch.yaml`, this should be the full URL of your backend service, e.g., `https://default-dot-YOUR_PROJECT_ID.appspot.com/api`).

2.  **Ensure `client/package.json` is ready:**
    *   `express` should be in `dependencies`.
    *   The `scripts` section should have:
        *   `"start": "node server.js"`
        *   `"build": "react-scripts build"`
        *   `"dev": "react-scripts start"` (for local development)

3.  **Build the Frontend:**
    Navigate to the `client` directory and build the production assets:
    ```bash
    cd client
    npm run build
    cd ..
    ```
    This creates a `client/build` directory containing the static assets.

4.  **Deploy the Frontend Service:**
    You can deploy the frontend service from the project root directory:
    ```bash
    gcloud app deploy client/app.yaml
    ```
    Or, navigate into the `client` directory and deploy:
    ```bash
    cd client
    gcloud app deploy app.yaml # This refers to client/app.yaml
    cd ..
    ```

### 5. Configure Routing with `dispatch.yaml` (Optional but Recommended)

To route traffic to your `default` (backend) and `frontend` services from a single domain (e.g., `YOUR_PROJECT_ID.appspot.com`), use a `dispatch.yaml` file.

1.  **Review `dispatch.yaml`:**
    The `dispatch.yaml` file in the project root should look like this:
    ```yaml
    dispatch:
      - url: "*/api/*"
        service: default
      - url: "*/.*"
        service: frontend
    ```
    This routes requests starting with `/api/` to the `default` (backend) service and all other requests to the `frontend` service.

2.  **Deploy `dispatch.yaml`:**
    From the project root directory (where `dispatch.yaml` is located):
    ```bash
    gcloud app deploy dispatch.yaml
    ```
    Dispatch rules may take a few minutes to propagate.

### 6. Accessing Your Application

*   **If using `dispatch.yaml`:** Your application should be accessible at `https://YOUR_PROJECT_ID.appspot.com`.
*   **If not using `dispatch.yaml`:**
    *   Frontend: `https://frontend-dot-YOUR_PROJECT_ID.appspot.com`
    *   Backend API: `https://default-dot-YOUR_PROJECT_ID.appspot.com/api` (or `https://YOUR_PROJECT_ID.appspot.com/api` if backend is the only service or default service and no dispatch rules).

Replace `YOUR_PROJECT_ID` with your actual GCP Project ID. You can find your App Engine URLs in the GCP Console under App Engine -> Dashboard or Services.

### Setting Environment Variables in GCP

As mentioned in the backend deployment steps, environment variables (especially secrets) should be managed securely.

**Methods:**

1.  **Using `gcloud app deploy` with `app.yaml`:**
    For non-sensitive variables, you can list them under `env_variables` in the respective `app.yaml` files.
    ```yaml
    # In app.yaml or client/app.yaml
    env_variables:
      NODE_ENV: 'production'
      APP_BASE_URL: 'https://your-app-url.com' # For backend
      REACT_APP_API_URL: '/api' # For frontend build
    ```

2.  **Using `gcloud app services update` (Recommended for secrets post-deployment):**
    This method allows you to update environment variables without redeploying the entire application code.
    ```bash
    gcloud app services update <service-name> --update-env-vars KEY1=VALUE1,KEY2=VALUE2
    ```
    Example for backend (`default` service):
    ```bash
    gcloud app services update default --update-env-vars MONGODB_URI="...",JWT_SECRET="..."
    ```
    Example for frontend (`frontend` service, if it needs runtime env vars not baked into build):
    ```bash
    gcloud app services update frontend --update-env-vars SOME_FRONTEND_VAR="value"
    ```
    *Note: `REACT_APP_*` variables for Create React App are typically build-time variables. Setting them via `--update-env-vars` for the frontend service might not affect the already built static assets unless your `server.js` is designed to inject them dynamically (which is not standard for CRA).*
    The `REACT_APP_API_URL` in `client/app.yaml` is used during the App Engine build process when `npm run build` is executed on the server.

3.  **Using the GCP Console:**
    *   Navigate to App Engine -> Services in the GCP Console.
    *   Select your service (e.g., `default` or `frontend`).
    *   Go to the "Configuration" tab (or "Settings" depending on the console version).
    *   Edit "Environment variables".

4.  **Using Google Cloud Secret Manager (Most Secure for Secrets):**
    *   Store your secrets (like API keys, database passwords, JWT secrets) in Secret Manager.
    *   Grant your App Engine service account (usually `PROJECT_ID@appspot.gserviceaccount.com`) the "Secret Manager Secret Accessor" IAM role for the specific secrets.
    *   Modify your application code (`app.js` or `config/db.js`) to fetch these secrets at runtime using the Google Cloud client libraries.
    *   This is the most secure method and avoids placing secrets directly in App Engine environment variables.

    Example (conceptual, in your Node.js app):
    ```javascript
    // const { SecretManagerServiceClient } = require('@google-cloud/secret-manager');
    // const client = new SecretManagerServiceClient();
    // async function getSecret(secretName) {
    //   const [version] = await client.accessSecretVersion({
    //     name: `projects/YOUR_PROJECT_ID/secrets/${secretName}/versions/latest`,
    //   });
    //   return version.payload.data.toString('utf8');
    // }
    // async function loadConfig() {
    //   process.env.MONGODB_URI = await getSecret('mongodb-uri-secret');
    //   process.env.JWT_SECRET = await getSecret('jwt-secret');
    //   // ... load other secrets
    // }
    // loadConfig().then(() => { /* start your app */ });
    ```
    You would need to add `@google-cloud/secret-manager` to your `package.json` dependencies.

Choose the method that best suits your security and operational needs. For production, Secret Manager is highly recommended for sensitive data.

## Platform-Specific Setup Guides

This section provides links and tips for installing the prerequisites on different operating systems.

### Node.js & npm/yarn

Node.js is required for both backend and frontend development. npm is included with Node.js.

*   **All Platforms (Recommended):** Use a Node Version Manager (nvm) to easily switch between Node.js versions.
    *   **nvm (macOS/Linux/WSL):** [Installation Guide](https://github.com/nvm-sh/nvm#installing-and-updating)
        ```bash
        # Example: Install latest LTS version after installing nvm
        nvm install --lts
        nvm use --lts
        ```
    *   **nvm-windows (Windows):** [Installation Guide](https://github.com/coreybutler/nvm-windows#installation--upgrades)
*   **Direct Downloads:**
    *   **All Platforms:** [Node.js Official Website](https://nodejs.org/) (Download the LTS version)

### MongoDB

You'll need a MongoDB server for local development if you're not using a cloud-hosted instance like MongoDB Atlas for development.

*   **macOS:**
    *   **Homebrew:**
        ```bash
        brew tap mongodb/brew
        brew install mongodb-community
        # To start MongoDB:
        brew services start mongodb-community
        ```
    *   **Docker:** Run MongoDB in a Docker container. [MongoDB Docker Hub](https://hub.docker.com/_/mongo)
*   **Windows:**
    *   **Official Installer:** [MongoDB Community Server Download](https://www.mongodb.com/try/download/community)
    *   **WSL (Windows Subsystem for Linux):** Install MongoDB within your WSL distribution (e.g., Ubuntu) using its package manager.
    *   **Docker:** Run MongoDB in a Docker container.
*   **Ubuntu (Linux):**
    *   **Official .deb packages:** Follow the [MongoDB Installation Guide for Ubuntu](https://www.mongodb.com/docs/manual/tutorial/install-mongodb-on-ubuntu/).
    *   **Docker:** Run MongoDB in a Docker container.

### Google Cloud SDK (gcloud CLI)

The `gcloud` command-line tool is essential for deploying to GCP.

*   **All Platforms:** Follow the official [Google Cloud SDK Installation Guide](https://cloud.google.com/sdk/docs/install).
    *   The guide provides instructions for Linux, macOS, and Windows, including an interactive installer or using package managers.
    *   After installation, initialize the SDK:
        ```bash
        gcloud init
        ```
        This will guide you through logging in, selecting a project, and configuring a default region/zone.
